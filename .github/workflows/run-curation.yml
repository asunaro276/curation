name: Tech News Curation

on:
  # Daily at 11 PM UTC (8 AM JST)
  schedule:
    - cron: '0 23 * * *'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  curate-news:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Ruby gems
        id: cache-gems
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-ruby-3.2-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-ruby-3.2-gems-

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false  # キャッシュは明示的に管理

      - name: Configure Bundler
        run: |
          bundle config set --local path 'vendor/bundle'

      - name: Install dependencies
        if: steps.cache-gems.outputs.cache-hit != 'true'
        run: |
          echo "キャッシュミス: bundle install を実行します"
          bundle install --jobs 4 --retry 3

      - name: Display cache status
        run: |
          if [ "${{ steps.cache-gems.outputs.cache-hit }}" == "true" ]; then
            echo "✅ キャッシュヒット: Gemfile.lock が変更されていません"
            echo "bundle install はスキップされました"
          else
            echo "❌ キャッシュミス: 依存関係を新規インストールしました"
            echo "次回実行時はキャッシュが利用されます"
          fi

      - name: Verify configuration
        run: |
          if [ ! -f config/sources.yml ]; then
            echo "Error: config/sources.yml not found"
            exit 1
          fi

      - name: Run tech news curation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
          LINE_GROUP_ID: ${{ secrets.LINE_GROUP_ID }}
          ENABLED_NOTIFIERS: ${{ secrets.ENABLED_NOTIFIERS }}
          LOG_LEVEL: INFO
        run: |
          bundle exec ruby bin/run

      - name: Report status on failure
        if: failure()
        run: |
          echo "Tech news curation failed"
          echo "Check the logs above for details"
