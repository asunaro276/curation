# Proposal: Ruby依存関係キャッシュの最適化

## 概要
GitHub ActionsのRubyセットアップにおいて、Gemfile.lockをキーとしたより明示的で制御可能な依存関係キャッシュを実装する。現在のbundler-cache機能を維持しつつ、キャッシュヒット率の可視化と最適化を行う。

## Why
- 現在のbundler-cache: trueは動作しているが、キャッシュの動作が暗黙的で可視化されていない
- GitHub Actions実行時間の短縮とコスト最適化
- Gemfile.lockが変更されない場合の高速なビルド実行
- キャッシュヒット/ミスの明示的な確認とデバッグ容易性の向上

## What Changes
1. Gemfile.lockをキャッシュキーとした明示的なキャッシュ設定
2. キャッシュヒット/ミスの可視化
3. bundle install実行時間の短縮（キャッシュヒット時）
4. 既存の動作との互換性維持

## 範囲内
- actions/cacheを使用した明示的なキャッシュ設定
- Gemfile.lockベースのキャッシュキー生成
- キャッシュヒット/ミスの明示的なログ出力
- キャッシュの保存と復元の明示的な制御
- キャッシュパス（vendor/bundle）の明示的な設定
- bundle installのスキップ条件の明確化

## 範囲外
- Gemfile以外の依存関係のキャッシュ
- Docker imageのキャッシュ
- 他のGitHub Actionsワークフローへの適用
- キャッシュの自動削除や有効期限管理（GitHub標準動作に依存）
- 複数のRubyバージョンに対するキャッシュ戦略

## 影響を受けるコンポーネント
- **修正**: `.github/workflows/run-curation.yml` - キャッシュ設定の明示化
- **新規**: キャッシュヒット/ミスのログ出力ステップ
- **動作変更なし**: Ruby環境のセットアップ手順（互換性維持）

## 依存関係
- actions/cache@v4 - キャッシュの保存・復元
- ruby/setup-ruby@v1 - Rubyのセットアップ
- Gemfile.lock - キャッシュキーの生成元

## リスクと緩和策
| リスク | 影響 | 緩和策 |
|--------|------|--------|
| キャッシュ設定の複雑化 | 低 | シンプルな設定を維持、既存のbundler-cacheと同等の動作 |
| キャッシュの不整合 | 低 | Gemfile.lockのハッシュを正確に使用 |
| ディスク使用量の増加 | 低 | GitHub標準のキャッシュ有効期限に依存 |
| 既存ワークフローへの影響 | 低 | 後方互換性を維持、段階的な移行が可能 |

## 代替案
1. **現在のbundler-cache: trueを継続使用**: シンプルだが、可視化と制御が限定的
2. **Docker imageにRuby環境を含める**: 複雑で、メンテナンスコストが増加
3. **依存関係をリポジトリにコミット**: セキュリティリスクとリポジトリサイズの増加

## 成功基準
- [ ] Gemfile.lockが変更されない場合、キャッシュがヒットする
- [ ] キャッシュヒット時、bundle installがスキップまたは高速化される
- [ ] キャッシュヒット/ミスがワークフローログで明確に確認できる
- [ ] 既存のワークフローが正常に動作する
- [ ] GitHub Actions実行時間が変わらないか短縮される

## タイムライン
- フェーズ1: ワークフロー設定の調査と設計 (0.5日)
- フェーズ2: actions/cacheの実装とテスト (0.5日)
- フェーズ3: 動作確認とドキュメント更新 (0.5日)

合計見積もり: 1.5日

## 関連Capability
- `ruby-dependency-caching`: Gemfile.lockベースのRuby依存関係キャッシュ
