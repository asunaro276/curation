# Capability: 日付フィルタリング (date-filtering)

## Purpose
記事収集時に、前日（日本時間0時〜24時）に公開された記事のみを対象とするフィルタリング機能を提供します。これにより、毎日のキュレーションが一貫した時間範囲の記事に絞られ、情報の鮮度と品質が向上します。

## MODIFIED Requirements

### Requirement: 前日の記事のみを収集
システムは、前日の日本時間0時0分0秒から23時59分59秒までに公開された記事のみを収集しなければならない (MUST)。

> **既存動作との差分**: 既存の `news-collection` capability では、公開日時に関係なく記事を収集し、`max_articles_per_source` で数量制限のみを適用していました。この変更により、日付範囲によるフィルタリングが追加されます。

#### Scenario: 前日の記事が含まれる
**Given** 現在時刻が2025年1月15日10時0分0秒（日本時間）である
**And** RSSフィードに以下の記事が含まれている:
  - 記事A: 2025年1月14日8時0分0秒に公開
  - 記事B: 2025年1月14日23時30分0秒に公開
  - 記事C: 2025年1月13日12時0分0秒に公開（前々日）
  - 記事D: 2025年1月15日1時0分0秒に公開（当日）
**When** 記事収集プロセスが実行される
**Then** 記事Aと記事Bが収集される
**And** 記事Cと記事Dは除外される
**And** ログに「Collected 2 articles」と記録される

#### Scenario: 境界値のテスト（前日の開始時刻）
**Given** 現在時刻が2025年1月15日0時0分0秒（日本時間）である
**And** RSSフィードに2025年1月14日0時0分0秒に公開された記事が含まれている
**When** 記事収集プロセスが実行される
**Then** その記事が収集される

#### Scenario: 境界値のテスト（前日の終了時刻）
**Given** 現在時刻が2025年1月15日23時59分59秒（日本時間）である
**And** RSSフィードに2025年1月14日23時59分59秒に公開された記事が含まれている
**When** 記事収集プロセスが実行される
**Then** その記事が収集される

## ADDED Requirements

### Requirement: 公開日時がない記事の除外
公開日時（published_at）が取得できない記事は、収集対象から除外しなければならない (MUST)。除外時には警告ログを記録する (MUST)。

#### Scenario: published_atがnilの記事を除外
**Given** RSSフィードに以下の記事が含まれている:
  - 記事A: 前日に公開（published_at有り）
  - 記事B: published_atがnull
**When** 記事収集プロセスが実行される
**Then** 記事Aのみが収集される
**And** 記事Bは除外される
**And** ログに「Skipping article without published_at」と警告が記録される

#### Scenario: 全ての記事にpublished_atがない場合
**Given** RSSフィードの全記事がpublished_atを持たない
**When** 記事収集プロセスが実行される
**Then** 収集される記事は0件となる
**And** 各記事に対して警告ログが記録される

### Requirement: タイムゾーンの明示的な設定
システムの動作タイムゾーンは環境変数で明示的に設定されなければならない (MUST)。GitHub Actionsでは `TZ=Asia/Tokyo` を設定する (MUST)。

#### Scenario: GitHub Actionsでの日本時間設定
**Given** GitHub Actionsワークフローファイルに環境変数 `TZ=Asia/Tokyo` が設定されている
**When** ワークフローが実行される
**Then** システムの現在時刻が日本時間として扱われる
**And** 前日の計算も日本時間基準で行われる

#### Scenario: ローカル開発環境での動作
**Given** ローカル環境でシステムのタイムゾーンがUTCまたは他のタイムゾーンに設定されている
**When** 記事収集プロセスが実行される
**Then** システムのタイムゾーンに従って前日が計算される
**And** 日本時間での動作を保証したい場合は、環境変数 `TZ=Asia/Tokyo` を設定する必要がある

### Requirement: フィルタリングと数量制限の順序
日付によるフィルタリングは、数量制限（max_articles_per_source）の前に実行されなければならない (MUST)。

> **理由**: まず日付範囲で絞り込んだ後に、その中から最大記事数を取得するのが論理的な順序です。

#### Scenario: フィルタリング後に数量制限が適用される
**Given** `max_articles_per_source` が3に設定されている
**And** RSSフィードに前日の記事が5件含まれている
**When** 記事収集プロセスが実行される
**Then** まず5件全てが日付フィルタリングを通過する
**And** その後、最初の3件のみが数量制限により選択される
**And** 最終的に3件の記事が返される

#### Scenario: 日付フィルタリングで記事数が減る場合
**Given** `max_articles_per_source` が5に設定されている
**And** RSSフィードに前日の記事が2件、前々日の記事が10件含まれている
**When** 記事収集プロセスが実行される
**Then** 日付フィルタリングにより2件のみが残る
**And** 数量制限（5件）よりも少ないため、2件全てが返される

## 関連Capability
- `news-collection`: この capability を拡張し、日付範囲による絞り込み機能を追加します
- `content-summarization`: フィルタリング後の記事が要約処理に渡されます
